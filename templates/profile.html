{% extends "layout.html" %}

{% block title %}Profiili - Coachfinder{% endblock %}

{% block content %}
<h2>Oma profiili</h2>

{% if session.username %}
<section class="profile-info" aria-labelledby="profile-image-heading">
  <h3 id="profile-image-heading">Profiilikuva</h3>
  {% if user.has_image %}
  <img src="/image/{{ user.id }}" class="profile-image" alt="Oma profiilikuvasi" />
  <p>
    <a href="/add_image">Muuta kuvaa</a> |
    <a href="/confirm_delete_image">Poista kuva</a>
  </p>
  {% else %}
  <p><em>Ei profiilikuvia</em> | <a href="/add_image">Lisää profiilikuva</a></p>
  {% endif %}
</section>

<section aria-labelledby="display-name-heading">
  <h3 id="display-name-heading">Näyttönimi</h3>
  <form method="POST">
    <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
    <p>
      <label for="display_name">Näyttönimi:</label><br>
      <input type="text" id="display_name" name="display_name" value="{{ current_display_name or '' }}" placeholder="Syötä nimesi" maxlength="50">
    </p>
    <p>
      <small>Tämä nimi näkyy ilmoituksissasi.</small>
    </p>
    <p>
      <input type="submit" value="Tallenna">
    </p>
  </form>
</section>

<section class="profile-info" aria-labelledby="account-info-heading">
  <h3 id="account-info-heading">Tilitiedot</h3>
  <p><strong>Käyttäjätunnus:</strong> {{ session.username }}</p>
  {% if current_display_name %}
  <p><strong>Nykyinen näyttönimi:</strong> {{ current_display_name }}</p>
  {% else %}
  <p><em>Ei näyttönimeä asetettu</em></p>
  {% endif %}
</section>

<section aria-labelledby="age-distribution-heading">
  <h3 id="age-distribution-heading">Oppilaiden ikäryhmien jakauma</h3>
  <div class="age-distribution-chart">
    {% for group in age_distribution %}
      <div class="age-group-bar">
        <div class="age-group-label">{{ group.age_group }}</div>
        <div class="age-group-bar-container">
          <div class="age-group-bar-fill{% if group.age_group == user_age_group %} user-age-group{% endif %}" style="--bar-width: {{ group.percentage }}%; width: var(--bar-width);">
            <span class="age-group-percentage">{{ group.percentage }}%</span>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% if user_age_group and user_percentage > 0 %}
    <p class="age-distribution-caption">
      Oppilaista {{ user_percentage }}% kuuluu ikäryhmääsi ({{ user_age_group }})
    </p>
  {% endif %}
</section>

<section aria-labelledby="my-announcements-heading">
  <h3 id="my-announcements-heading">Ilmoitukseni</h3>
  {% set total_announcements = (student_announcements|length) + (coach_announcements|length) %}
  {% if total_announcements > 0 %}
    {% if total_announcements == 1 %}
      <p>Sinulla on {{ total_announcements }} ilmoitus.</p>
    {% else %}
      <p>Sinulla on {{ total_announcements }} ilmoitusta.</p>
    {% endif %}
    
    {% if student_announcements %}
    <h4>Oppilasilmoitukset (Etsin valmentajaa)</h4>
    {% for announcement in student_announcements %}
      <article class="announcement">
        <h5><a href="/announcement/{{ announcement.id }}">{{ announcement.sport }}</a></h5>
        <p><strong>Kaupunki:</strong> {{ announcement.city }}</p>
        <p><strong>Ikäryhmä:</strong> {{ announcement.age_group }}</p>
        <p><strong>Taitotaso:</strong> {{ announcement.skill_level }}</p>
        <div class="description"><strong>Kuvaus:</strong> {{ announcement.description.strip() }}</div>
      </article>
    {% endfor %}
    {% endif %}
    
    {% if coach_announcements %}
    <h4>Valmentajailmoitukset (Etsin valmennettavaa)</h4>
    {% for announcement in coach_announcements %}
      <article class="announcement">
        <h5><a href="/announcement_coach/{{ announcement.id }}">{{ announcement.sport }}</a></h5>
        <p><strong>Kaupunki:</strong> {{ announcement.city }}</p>
        <p><strong>Kokemus:</strong> {{ announcement.experience_level }}</p>
        <div class="description"><strong>Kuvaus:</strong> {{ announcement.description.strip() }}</div>
      </article>
    {% endfor %}
    {% endif %}
  {% else %}
    <p>Sinulla ei ole vielä ilmoituksia.</p>
  {% endif %}
</section>

{% else %}
<p>Sinun täytyy kirjautua sisään nähdäksesi profiilin.</p>
{% endif %}
{% endblock %}